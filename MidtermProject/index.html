<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>title</title>
		<meta name="author" content="name">
		<meta name="description" content="description here">
		<meta name="keywords" content="keywords,here">
		<link rel="stylesheet" href="styles/styles.css" type="text/css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
		<script src="js/d3.min.js" type="text/javascript"></script>
		<style type="text/css">
            svg text{
                fill: black;
            }
            svg circle{
                fill: rgba(0, 0, 200, 0.7);
            }
            svg circle.selected{
                fill: rgba(200, 0, 0, 0.7);
            }

            .axis path{
                fill: none;
                stroke: #333;
            }

            .x.axis,
            .y.axis{
                font-size: 16px;
                color: #333;
            }

            .d3-tip {
              font-size: 10px;
              padding: 8px;
              background: rgba(0, 0, 0, 0.8);
              color: #fff;
            }

        </style>
	</head>
	<body>
  		<script type="text/javascript">
  		 var graph;
            // var SortType
            var DataType = {
            	GOAL:"Goal",
            	PLEDGED:"Pledged",
            	PLEDGEHYPE:"PledgeHype",
            	BACKERS:"Backers",
            	BACKERHYPE:"BackerHype"
            };
                       
            d3.tsv('data/data.tsv', function(error, data){
                console.log('called load data');
                if(error){
                    console.log(error);
                }else{
                	data.forEach(function(d) {
                		d.Goal = parseInt (d.Goal);
			            d.Pledged = parseInt (d.Pledged);
			            d.PledgeHype = parseInt (d.PledgeHype);
			            d.Backers = parseInt(d.Backers);
			            d.BackerHype = parseInt(d.BackerHype);
			            d.launched_at = new Date(d.launched_at);
			            d.created_at = new Date(d.created_at);
			            d.deadline = new Date(d.deadline);
			        });
                    graph = Graph (data);
                    graph.setup ();
                }
            });
           
            var Graph = function (_data) {
            	var obj = {};
            	// var rawData = _data;
            	obj.currentScaler = DataType.GOAL;
            	var margin = {top: 50, right: 100, bottom: 250, left: 100};
                var width = window.innerWidth - margin.left - margin.right;
                var height = window.innerHeight - margin.top - margin.bottom;

                var svg, chart, 

                	sortXToggleTime,
                	sortXToggleGoal,
                	sortXToggleBackers,
                	sortXToggleBackerHype,
                	sortXTogglePledged,
                	sortXTogglePledgeHype,
                	
                	xScale, yScale, 
                	xAxis, yAxis;

                var textControlsY = 20,
                	textHypeXOffset = 40,
                	textRawXOffset = 140;

                // var textControllerRaw,
                // 	textControllerHype;

                // var tooltipHeader,
                // 	tooltipDescription;

                obj.data = _data;
                obj.yData;
                obj.xLimit = 50;
            	obj.setup = function () {
			        console.log (obj.data);

					svg = d3.select('body')
	                    .append('svg')
	                    .attr('width', window.innerWidth)
	                    .attr('height', window.innerHeight)
	                    ;

	                chart = svg.append('g')
	                    .attr('transform', 'translate('+margin.left+', '+margin.top+')')
	                    ;

	                // Appending the axis
	                chart.append('g')
	                    .attr('transform', 'translate(0, '+height+')')
	                    .attr('class', 'x axis')
	                    ;
	                chart.append('g')
	                    .attr('class', 'y axis')
	                    ;


	                // Appending controls
	    //             textControllerRaw = chart.append('text')
	    //             	.attr("x", width - textRawXOffset)
	    //             	.attr("y", - textControlsY)
	    //             	.attr("class", "rawToggle")
	    //             	// .text("Raw")
	    //             	.text("Pledged")
	    //             	.attr("font-family", "sans-serif")
					// 	.attr("font-size", "20px")
					// 	.attr("fill", "red")
					// 	;

					// textControllerHype = chart.append('text')
	    //             	.attr("x", width - textHypeXOffset)
	    //             	.attr("y", - textControlsY)
	    //             	.attr("class", "hypeToggle")
	    //             	// .text("Hype")
	    //             	.text("Backers")
	    //             	.attr("font-family", "sans-serif")
					// 	.attr("font-size", "20px")
					// 	.attr("fill", "red")
					// 	;

					chart.append('text')
						.attr("id", "tooltipHeader")
						.attr("x", 0)
						.attr("y", height + 50)
						.text("Hover on a bar for more info.")
						.attr("font-family", "sans-serif")
						.attr("font-weight", "bold")
						.attr()
						.attr("font-size", "20px")
						;
					chart.append('text')
						.attr("id", "tooltipDescription")
						.attr("x", 0)
						.attr("y", height + 80)
						.text("")
						.attr("font-family", "sans-serif")
						.attr("font-size", "20px")
						;

					chart.append('text')
						.attr("id", "tooltipGoal")
						.attr("x", 0)
						.attr("y", height + 110)
						.text("")
						.attr("font-family", "sans-serif")
						.attr("font-size", "20px")
						;
					chart.append('text')
						.attr("id", "tooltipPledged")
						.attr("x", 0)
						.attr("y", height + 140)
						.text("")
						.attr("font-family", "sans-serif")
						.attr("font-size", "20px")
						;
					chart.append('text')
						.attr("id", "tooltipBackers")
						.attr("x", 0)
						.attr("y", height + 170)
						.text("")
						.attr("font-family", "sans-serif")
						.attr("font-size", "20px")
						;


					chart.select(".rawToggle").on("click", function () {
						currentSort = DataType.PLEDGED;
			            graph.update (obj.data);						
					});

					chart.select(".hypeToggle").on("click", function () {
						currentSort = DataType.BACKERS;
	                	graph.update (obj.data);
					});

	                obj.update(obj.data);
            	};

            	obj.update = function () {
	 				// var xData = new ScalerData (rawData, currentSort);
	                // obj.yData = new ScalerData (obj.data, currentSort);
	               	// sortByType (dataset, false);
	               	var ascending = false;
	               	var adj = ascending ? 1 : -1;
            		// console.log("dataset");
            		// console.log(currentScaler);
            		obj.data.sort(function (a,b) {
            			if (a[obj.currentScaler] > b[obj.currentScaler]) 
            				return 1 * adj;
            			else if (a[obj.currentScaler] < b[obj.currentScaler]) 
            				return -1 * adj;
            			else 
            				return 0;
            		});

					//=====SCALES======
					xScale = d3.scale.ordinal()
	                    .range([0, width])           // output (min, max)
	                    ;

	               	var min = d3.min (obj.data, function(d,i) {
	                	return d[obj.currentScaler];
	                });
	                var max = d3.max (obj.data, function(d,i) {
	                	return d[obj.currentScaler];
	                });                

	                yScale = d3.scale.linear()
	                    .domain([min, max])
	                    .range([height, 0])           // output (min, max)
	                    ;   
                	
                	//=====AXIS======
	                xAxis = d3.svg.axis()
	                    .scale(xScale)
	                    .orient('bottom')
	                    ;
	                yAxis = d3.svg.axis()
	                    .scale(yScale)
	                    .orient('left')
	                    ;

	                chart.select ('.x.axis')
	                	.transition()
                        .duration(2000)
	                	.call(xAxis)
	                	;

	                chart.select ('.y.axis')
	                	.transition()
                        .duration(2000)
	                	.call(yAxis)
	                	;

	                var barWidth = width / obj.xLimit;
	                var barFill = barWidth * .85;
	                
		            var bar = chart.selectAll ('rect')
	                	.data(obj.data)
	                	;
	                var barEnter = bar.enter()
	                	.append ('rect')
	                	;
	                var barUpdate = bar
	                	.filter(function (d,i) { return i < obj.xLimit; })	//limit to top 50 options
	                	.transition()
                        .duration(2000)
	                	.attr ('class', 'bar')
	                	.attr ('x', function (d, i) { return (width / obj.xLimit) * i; })
	                	.attr ('width', barFill)
	                	.attr ("y", function(d, i) { return yScale(d[obj.currentScaler]); })
	                	.attr ("height", function(d) { 
	                		var newheight = height - yScale(d[obj.currentScaler]);
	                		// if (currentScaler == "Pledged") {
	                		// 	newheight = height - yScale(d[])
	                		// }
	                		return newheight;
	                	})
	               	//TODO:
	                var barInteraction = bar
	                	.on ('mouseover', function (d, i) {
	                		d3.select(this)
	                		.style('fill', 'red')
	                		;
	                		// console.log(d);
	                		chart.select('#tooltipHeader')
	                			.text(d["name"])
	                			;
	                		chart.select('#tooltipDescription')
	                			.text(d["blurb"])
	                			;
	                		$('#tooltipGoal')
			            		.text("Goal: " + d["Goal"])
			            		;
			            	$('#tooltipPledged')
			            		.text("Pledged: " + d["Pledged"])
			            		;
			            	$('#tooltipBackers')
			            		.text("Backers: " + d["Backers"])
			            		;
	                		// chart.select()
	                	})
	                	.on ('mouseout', function (d, i) {
	                		d3.select(this)
	                		.style('fill', 'black')	
	                		;
	                	});
	                var barExit = bar.exit()
	                	.remove()
	                	;	
            	};

            	return obj;
            }

            function resort () {
            	console.log("resort");
            }

            function rescale () {
            	
            	graph.currentScaler = document.getElementById("rescale").value;
            	console.log(graph.currentScaler);
            	graph.update ();

            	$('#tooltipHeader')
            		.text("Hover on a bar for more info")
            		;
            	$('#tooltipDescription')
            		.text("")
            		;
            	$('#tooltipGoal')
            		.text("")
            		;
            	$('#tooltipPledged')
            		.text("")
            		;
            	$('#tooltipBackers')
            		.text("")
            		;
            	// chart.select('#tooltipHeader')
	            //     			.text(d["name"])
	            //     			;
	            //     		chart.select('#tooltipDescription')
	            //     			.text(d["blurb"])
	            //     			;
            }
     //        }
        </script>


        <select id="resort" onchange="resort()">
			<option value="time">Time</option>
			<option value="magnitude">Total</option>
			<option value="hype">Hype</option>
		</select>
		<select id="rescale" onchange="rescale()">
			<option value="Goal">Goal</option>
			<option value="Pledged">Pledged</option>
			<option value="PledgeHype">PledgeHype</option>
			<option value="Backers">Backers</option>
			<option value="BackerHype">BackerHype</option>
		</select>


	</body>
</html>