<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>title</title>
		<meta name="author" content="name">
		<meta name="description" content="description here">
		<meta name="keywords" content="keywords,here">
		<link rel="stylesheet" href="styles/styles.css" type="text/css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
		<script src="js/d3.min.js" type="text/javascript"></script>
		<style type="text/css">
            svg text{
                fill: black;
            }
            svg circle{
                fill: rgba(0, 0, 200, 0.7);
            }
            svg circle.selected{
                fill: rgba(200, 0, 0, 0.7);
            }

            .axis path{
                fill: none;
                stroke: #333;
            }

            .x.axis,
            .y.axis{
                font-size: 16px;
                color: #333;
            }

            .d3-tip {
              font-size: 10px;
              padding: 8px;
              background: rgba(0, 0, 0, 0.8);
              color: #fff;
            }

        </style>
	</head>
	<body>
  		<script type="text/javascript">
            d3.tsv('data/data.tsv', function(error, data){
                console.log('called load data');
                if(error){
                    console.log(error);
                }else{
                    graph = Graph (data);
                    graph.setup ();
                }
            });
            var graph;

            var DataType = {
            	GOAL:"Goal",
            	PLEDGED:"Pledged",
            	PLEDGEHYPE:"PledgeHype",
            	BACKERS:"Backers",
            	BACKERHYPE:"BackerHype"
            };
            var OrdinalType = {
            	// NAME: ""
            }
            // var SortType = {
            // 	TIME:"Goal",
            // 	PLEDGED:"Pledged",
            // 	BACKERS:"Backers"
            // };
            // var xSort = DataType.PLEDGED;	//x stuff
            var ySort = DataType.PLEDGED;	//y stuff
            
            var Graph = function (_data) {
            	var obj = {};
            	// obj.rawData = _data;
            	obj.data = _data;

            	var currentSort = DataType.PLEDGED;

            	obj.setSort = function (newSetting) {
            		currentSort = newSetting;
            	}

            	// var sortData = rawData;
            	var margin = {top: 100, right: 100, bottom: 100, left: 100};
                var width = window.innerWidth - margin.left - margin.right;
                var height = window.innerHeight - margin.top - margin.bottom;

                var svg, chart, 

                	sortXToggleTime,
                	sortXToggleGoal,
                	sortXToggleBackers,
                	sortXToggleBackerHype,
                	sortXTogglePledged,
                	sortXTogglePledgeHype,
                	
                	xScale, yScale, 
                	xAxis, yAxis;

                var textControlsY = 20,
                	textHypeXOffset = 40,
                	textRawXOffset = 140;

                var textControllerRaw,
                	textControllerHype

            	obj.setup = function () {
            		obj.data.forEach(function(d) {
			            d.Pledged = parseInt (d.Pledged);
			            d.PledgeHype = parseInt (d.PledgeHype);
			            d.Backers = parseInt(d.Backers);
			            d.BackerHype = parseInt(d.BackerHype);
			        });

			        obj.sortByType (obj.data, currentSort, 50, false);

			        console.log (obj.data);

					svg = d3.select('body')
	                    .append('svg')
	                    .attr('width', window.innerWidth)
	                    .attr('height', window.innerHeight)
	                    ;
	               
	                // svg.call(tip);                    

	                chart = svg.append('g')
	                    .attr('transform', 'translate('+margin.left+', '+margin.top+')')
	                    ;

	                // Appending the axis
	                chart.append('g')
	                    .attr('transform', 'translate(0, '+height+')')
	                    .attr('class', 'x axis')
	                    ;
	                chart.append('g')
	                    .attr('class', 'y axis')
	                    ;

	                textControllerRaw = chart.append('text')
	                	.attr("x", width - textRawXOffset)
	                	.attr("y", - textControlsY)
	                	.attr("class", "rawToggle")
	                	// .text("Raw")
	                	.text("Pledged")
	                	.attr("font-family", "sans-serif")
						.attr("font-size", "20px")
						.attr("fill", "red");

					textControllerHype = chart.append('text')
	                	.attr("x", width - textHypeXOffset)
	                	.attr("y", - textControlsY)
	                	.attr("class", "hypeToggle")
	                	// .text("Hype")
	                	.text("Backers")
	                	.attr("font-family", "sans-serif")
						.attr("font-size", "20px")
						.attr("fill", "red");


					d3.select(".rawToggle").on("click", function () {
						console.log("pledged Toggled");

						d3.tsv('data/data.tsv', function(error, data){
			                if(error){
			                    console.log(error);
			                }else{
			                    graph.data = data;
			                    currentSort = DataType.PLEDGED;
								obj.update();
								obj.sortByType (obj.data, currentSort, 50, false);
			                }
			            });

						
					});

					d3.select(".hypeToggle").on("click", function () {
						console.log("backers Toggled");
						d3.tsv('data/data.tsv', function(error, data){
			                if(error){
			                    console.log(error);
			                }else{
			                    graph.data = data;
			                    currentSort = DataType.BACKERS;
								obj.update();
								obj.sortByType (obj.data, currentSort, 50, false);
			                }
			            });
						
					});

	                // Appending controls


	                obj.update(obj.data);
            	};

            	obj.yData;
            	obj.update = function () {
	 				// var xData = new ScalerData (rawData, currentSort);
	                obj.yData = new ScalerData (obj.data, currentSort);
                
					//=====SCALES======
					xScale = d3.scale.ordinal()
	                    // .domain([xData.min, xData.max])   // input (min, max)
	                    // .rangeRoundBands([0, width], .1);
	                    .range([0, width])           // output (min, max)
	                    ;   
	                yScale = d3.scale.linear()
	                    .domain([obj.yData.min, obj.yData.max])   // input (min, max)
	                    .range([height, 0])           // output (min, max)
	                    ;   
                	
                	//=====AXIS======
	                xAxis = d3.svg.axis()
	                    .scale(xScale)
	                    .orient('bottom')
	                    ;
	                yAxis = d3.svg.axis()
	                    .scale(yScale)
	                    .orient('left')
	                    ;

	                d3.select ('.x.axis')
	                	.transition()
                        .duration(2000)
	                	.call(xAxis);
	                d3.select ('.y.axis')
	                	.transition()
                        .duration(2000)
	                	.call(yAxis);

	                var barWidth = width / obj.data.length;
	                var barFill = barWidth * .85;
	                

		            var bar = chart.selectAll ('bar')
	                	.data(obj.data)
	                	;
	                var barEnter = bar.enter()
	                	.append ('rect');
	                var barUpdate = bar
	                	.attr ('class', 'bar')
	                	.attr ('x', function (d, i) { return (width / obj.data.length) * i; })
	                	.attr ('width', barFill)
	                	.attr ("y", function(d) { return yScale(d[ySort]); })
	                	.attr ("height", function(d) { 
	                		var newheight = height - yScale(d[ySort]);

	                		// if (newheight === 0) {

	                		// 	console.log (height);
	                		// 	console.log (obj.yData.max);
	                		// 	console.log (d);
	                		// 	console.log (yScale);
	                		// 	console.log (ySort);
	                		// 	console.log (yScale(d[ySort]));
	                			
	                		// }
	                		return newheight;
	                	})
	                	.transition()
                        .duration(2000)
	                	.attr ("data-pledged", function (d) { return d["Pledged"] })
	                	.attr ("description", function (d) { return d["name"]; })
	                	;

	                //TODO:
	                var barInteraction = bar
	                	.on ('mouseover', function (d, i) {
	                		d3.select(this)
	                		.style('fill', 'red')
	                	})
	                	.on ('mouseout', function (d, i) {
	                		d3.select(this)
	                		.style('fill', 'black')	
	                	});
	                var barExit = bar.exit()
	                	.remove()
	                	;	
            	};

            	obj.log = function () {
            		// var returnString;
            		// console.log ("yScale");
            		// console.log ("yScale: " + yScale(obj.data[0][ySort]));
            		// console.log ("yScale: " + obj);
            		
            		// return yScale(obj.data[0][ySort]);
            		return yScale(obj.data);
            	};
            	// var setScale = function (_type) {
            	// 	var scale;
            	// 	switch (_type) {
            	// 		default:
            	// 		case DataType.Backers:

            	// 		break;
            	// 		case "Alp"
            	// 	}
            	// }

            	obj.sortByType = function (data, type, trimNum, ascending) {
            		var adj = ascending ? 1 : -1;
            		// var newData = Object.create(data);
            		var newData = data;
            		newData.sort(function (a,b) {
            			if (a[type] > b[type]) 
            				return 1 * adj;
            			else if (a[type] < b[type]) 
            				return -1 * adj;
            			else 
            				return 0;
            		});

            		newData.splice (trimNum);
            		obj.data = newData;
            	}

            	return obj;
            }
            var ScalerData = function (_data, _type) {
            	var data = {};
            	data.type = _type;

            	// switch  (_type) {
            	// 	default:
            	// 	case DataType.PLEDGED:
        		data.min = d3.min(_data, function (d,i) {
            		return d[_type];
            	});
            	data.max = d3.max(_data, function (d,i) {
                	return d[_type];
                });

	            //     case DataType.BACKERS:
            	// 	data.min = d3.min(_data, function (d,i) {
	            // 		return d[_type];
             //    	});
             //    	data.max = d3.max(_data, function (d,i) {
	            //     	return d[_type];
	            //     });
            	// 	break;

            	// 	// case SortType.BACKERS:

            	// 	// break;
            	// }

     //        	data.min = _reverseSort ? 
	    //         	d3.max(_data, function (d,i) {
	    //         		return d[_type];
	    //             }) :
	    //         	d3.min(_data, function (d,i) {
	    //         		return d[_type];
     //            	});

	    //         data.max = _reverseSort ? 
	    //         	d3.min(_data, function (d,i) {
     //            		return d[_type];
     //            	}) :
					// d3.max(_data, function (d,i) {
	    //             	return d[_type];
	    //             });
	            return data;
            }
        </script>
	</body>
</html>